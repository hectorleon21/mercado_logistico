<!-- E:\Desarrollo\MercadoLogisticoDev\Web\mercado_logistico\logistics\templates\logistics\includes\newsletter_modal.html -->
<div id="newsletterModal" class="modal fade-in" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Suscríbete al Newsletter</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="spinner-overlay">
            <div class="spinner-content">
                <div class="spinner"></div>
                <div class="spinner-text">Registrando suscripción, espere un momento...</div>
            </div>
        </div>
        <form id="newsletterForm" class="modal-body">
            <div class="form-group">
                <label for="newsletter_nombre_completo">Nombres y Apellidos:</label>
                <input type="text" id="newsletter_nombre_completo" name="nombre_completo" required>
            </div>

            <div class="form-group">
                <label for="newsletter_rol">Cargo o Rol:</label>
                <input type="text" id="newsletter_rol" name="rol" required>
            </div>
            
            <div class="form-group">
                <label for="newsletter_correo">Email:</label>
                <input type="email" id="newsletter_correo" name="correo" required>
            </div>
            
            <div class="form-group">
                <label for="newsletter_sector">Sector:</label>
                <select id="newsletter_sector" name="sector" required>
                    <option value="">Selecciona un sector</option>
                    <option value="Aficiones y casinos">Aficiones y casinos</option>
                    <option value="Agricultura y ganadería">Agricultura y ganadería</option>
                    <option value="Agua y aguas residuales">Agua y aguas residuales</option>
                    <option value="Alimentos">Alimentos</option>
                    <option value="Arquitectura">Arquitectura</option>
                    <option value="Arte y cultura">Arte y cultura</option>
                    <option value="Asistencia y cuidados">Asistencia y cuidados</option>
                    <option value="Banca y AFP">Banca y AFP</option>
                    <option value="Bebidas alcohólicas">Bebidas alcohólicas</option>
                    <option value="Bebidas sin alcohol">Bebidas sin alcohol</option>
                    <option value="Centros comerciales y outlets">Centros comerciales y outlets</option>
                    <option value="Combustibles fósiles">Combustibles fósiles</option>
                    <option value="Comercio al por mayor">Comercio al por mayor</option>
                    <option value="Comercio electrónico">Comercio electrónico</option>
                    <option value="Comercio internacional">Comercio internacional</option>
                    <option value="Construcción naval">Construcción naval</option>
                    <option value="Cosmética y cuidado personal">Cosmética y cuidado personal</option>
                    <option value="Deporte, fitness y ocio">Deporte, fitness y ocio</option>
                    <option value="Educación y ciencia">Educación y ciencia</option>
                    <option value="Electrónica">Electrónica</option>
                    <option value="Energía y medio ambiente">Energía y medio ambiente</option>
                    <option value="Equipamiento del hogar">Equipamiento del hogar</option>
                    <option value="Estado de salud">Estado de salud</option>
                    <option value="Ferreterías y Bricolage">Ferreterías y Bricolage</option>
                    <option value="Finanzas, seguros y bienes inmuebles">Finanzas, seguros y bienes inmuebles</option>
                    <option value="Gestión de residuos">Gestión de residuos</option>
                    <option value="Hospitales, farmacias y médicos">Hospitales, farmacias y médicos</option>
                    <option value="Industria aeroespacial">Industria aeroespacial</option>
                    <option value="Industria de defensa">Industria de defensa</option>
                    <option value="Industria de software">Industria de software</option>
                    <option value="Industria farmacéutica">Industria farmacéutica</option>
                    <option value="Ingeniería">Ingeniería</option>
                    <option value="Ingeniería civil">Ingeniería civil</option>
                    <option value="Juegos de azar">Juegos de azar</option>
                    <option value="Juguetes">Juguetes</option>
                    <option value="Mascotas">Mascotas</option>
                    <option value="Material de oficina">Material de oficina</option>
                    <option value="Metalurgia y electrónica">Metalurgia y electrónica</option>
                    <option value="Minería, metales y minerales">Minería, metales y minerales</option>
                    <option value="Ministerios y Gobierno">Ministerios y Gobierno</option>
                    <option value="Mobiliario">Mobiliario</option>
                    <option value="Operador Logístico">Operador Logístico</option>
                    <option value="Papel y pasta de papel">Papel y pasta de papel</option>
                    <option value="Parques y actividades al aire libre">Parques y actividades al aire libre</option>
                    <option value="Pesca y acuicultura">Pesca y acuicultura</option>
                    <option value="Plástico y caucho">Plástico y caucho</option>
                    <option value="Producción de vehículos">Producción de vehículos</option>
                    <option value="Productos de limpieza">Productos de limpieza</option>
                    <option value="Productos minerales no metálicos">Productos minerales no metálicos</option>
                    <option value="Productos químicos y materias primas">Productos químicos y materias primas</option>
                    <option value="Publicidad y marketing">Publicidad y marketing</option>
                    <option value="Refinerías de petróleo">Refinerías de petróleo</option>
                    <option value="Ropa y complementos">Ropa y complementos</option>
                    <option value="Salud e higiene">Salud e higiene</option>
                    <option value="Sector inmobiliario">Sector inmobiliario</option>
                    <option value="Tecnología médica">Tecnología médica</option>
                    <option value="Tecnología medioambiental">Tecnología medioambiental</option>
                    <option value="Tecnología y telecomunicaciones">Tecnología y telecomunicaciones</option>
                    <option value="Turismo y hostelería">Turismo y hostelería</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group">
                <label for="newsletter_password">Contraseña:</label>
                <input type="password" id="newsletter_password" name="password" required>
                <small class="help-text">Mínimo 8 caracteres, incluyendo letras y números</small>
            </div>
            
            <div class="form-group">
                <label for="newsletter_password_confirm">Confirmar Contraseña:</label>
                <input type="password" id="newsletter_password_confirm" name="password_confirm" required>
            </div>

            <div id="newsletterMessage" class="message" style="display: none;"></div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Suscribirse</button>
            </div>
        </form>
    </div>
</div>

<!-- Script completamente reescrito para manejar el formulario -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Nuevo script del newsletter cargado");
    
    // Referencias a elementos del DOM
    const modal = document.getElementById('newsletterModal');
    const form = document.getElementById('newsletterForm');
    const messageDiv = document.getElementById('newsletterMessage');
    const spinnerOverlay = document.querySelector('.spinner-overlay');
    const openButtons = document.querySelectorAll('.open-newsletter-modal');
    const closeButtons = document.querySelectorAll('.close-modal');
    
    // Elementos del formulario
    const nombreInput = document.getElementById('newsletter_nombre_completo');
    const rolInput = document.getElementById('newsletter_rol');
    const correoInput = document.getElementById('newsletter_correo');
    const sectorSelect = document.getElementById('newsletter_sector');
    const passwordInput = document.getElementById('newsletter_password');
    const confirmPasswordInput = document.getElementById('newsletter_password_confirm');
    
    // Funciones básicas
    function openModal() {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('fade-in'), 10);
    }
    
    function closeModal() {
        modal.classList.remove('fade-in');
        setTimeout(() => {
            modal.style.display = 'none';
            form.reset();
            messageDiv.style.display = 'none';
        }, 300);
    }
    
    function showSpinner() { spinnerOverlay.style.display = 'flex'; }
    function hideSpinner() { spinnerOverlay.style.display = 'none'; }
    
    function showError(message) {
        messageDiv.textContent = message;
        messageDiv.className = "message error";
        messageDiv.style.display = "block";
    }
    
    // Asignar eventos
    openButtons.forEach(btn => btn.addEventListener('click', openModal));
    closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
    modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
    
    // Validar contraseñas antes del submit
    confirmPasswordInput.addEventListener('input', function() {
        if (passwordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.setCustomValidity("Las contraseñas no coinciden");
        } else {
            confirmPasswordInput.setCustomValidity("");
        }
    });
    
    passwordInput.addEventListener('input', function() {
        if (confirmPasswordInput.value && passwordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.setCustomValidity("Las contraseñas no coinciden");
        } else {
            confirmPasswordInput.setCustomValidity("");
        }
    });
    
    // Manejar envío del formulario
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log("Formulario enviado - versión nueva");
        
        // Validación previa al envío
        if (!nombreInput.value.trim()) {
            showError("Por favor, ingresa tu nombre completo");
            return;
        }
        
        if (!rolInput.value.trim()) {
            showError("Por favor, ingresa tu cargo o rol");
            return;
        }
        
        if (!correoInput.value.trim()) {
            showError("Por favor, ingresa tu correo electrónico");
            return;
        }
        
        if (!sectorSelect.value) {
            showError("Por favor, selecciona tu sector");
            return;
        }
        
        if (!passwordInput.value) {
            showError("Por favor, ingresa una contraseña");
            return;
        }
        
        if (passwordInput.value.length < 8) {
            showError("La contraseña debe tener al menos 8 caracteres");
            return;
        }
        
        if (!confirmPasswordInput.value) {
            showError("Por favor, confirma tu contraseña");
            return;
        }
        
        // Validación específica para contraseñas que no coinciden
        if (passwordInput.value !== confirmPasswordInput.value) {
            console.log("Contraseñas no coinciden:", passwordInput.value, confirmPasswordInput.value);
            showError("Las contraseñas no coinciden");
            return;
        }
        
        // Recopilar datos del formulario
        const formData = {
            nombre_completo: nombreInput.value.trim(),
            rol: rolInput.value.trim(),
            correo: correoInput.value.trim(),
            sector: sectorSelect.value,
            password: passwordInput.value,
            password_confirm: confirmPasswordInput.value
        };
        
        // Log de datos (ocultando contraseñas)
        console.log("Datos a enviar:", {
            ...formData, 
            password: '***', 
            password_confirm: '***'
        });
        
        // Mostrar spinner y enviar datos
        showSpinner();
        
        // Función para obtener el token CSRF
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Enviar datos
        fetch('/api/newsletter-subscription/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json().then(data => ({ status: response.status, data })))
        .then(({status, data}) => {
            hideSpinner();
            
            if (status === 201) {
                messageDiv.textContent = `¡Gracias por suscribirte! Te hemos enviado un correo de confirmación. Ya puedes acceder con tu correo y contraseña.`;
                messageDiv.className = 'message success';
                setTimeout(closeModal, 7000);
            } else {
                if (data.error && data.error.includes('ya está suscrito')) {
                    messageDiv.textContent = 'Este correo ya está suscrito al newsletter.';
                } else if (data.detalles) {
                    // Mensajes específicos para ciertos errores
                    if (data.detalles.correo && data.detalles.correo[0].includes('already exists')) {
                        messageDiv.textContent = 'Este correo electrónico ya está registrado en el newsletter.';
                    } else {
                        // Para otros errores, mostrar los mensajes del backend
                        let errorMsg = '';
                        for (const [field, error] of Object.entries(data.detalles)) {
                            // Traducir nombres de campos
                            let fieldName = field;
                            switch(field) {
                                case 'nombre_completo': fieldName = 'Nombres y Apellidos'; break;
                                case 'rol': fieldName = 'Cargo o Rol'; break;
                                case 'correo': fieldName = 'Email'; break;
                                case 'sector': fieldName = 'Sector'; break;
                                case 'password': fieldName = 'Contraseña'; break;
                                case 'password_confirm': fieldName = 'Confirmar Contraseña'; break;
                            }
                            // Si es un array, tomar solo el primer mensaje
                            const errorMessage = Array.isArray(error) ? error[0] : error;
                            errorMsg += `${fieldName}: ${errorMessage}. `;
                        }
                        messageDiv.textContent = errorMsg || 'Por favor, corrige los errores en el formulario.';
                    }
                } else {
                    messageDiv.textContent = data.error || 'Ocurrió un error. Por favor, intenta nuevamente.';
                }
                messageDiv.className = 'message error';
            }
            
            messageDiv.style.display = 'block';
        })
        .catch(error => {
            hideSpinner();
            console.error('Error:', error);
            messageDiv.textContent = 'Ocurrió un error. Por favor, intenta nuevamente.';
            messageDiv.className = 'message error';
            messageDiv.style.display = 'block';
        });
    });
});
</script>
